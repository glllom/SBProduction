name: Django Auto-Deploy

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # English comment: Deploy directly to the root of the workspace
          path: .

      - name: Production Update
        shell: powershell
        run: |
          # Now manage.py is right here in C:\actions-runner\_work\SBProduction
          
          # 1. Setup environment (English: creating venv if it doesn't exist)
          if (!(Test-Path "venv")) { python -m venv venv }

          # 2. Update and migrate
          & ".\venv\Scripts\python.exe" -m pip install -r requirements.txt
          & ".\venv\Scripts\python.exe" manage.py migrate --noinput
          
          # 3. Restart service
          Restart-Service -Name "DjangoAPI" -Force