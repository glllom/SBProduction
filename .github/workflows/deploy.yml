name: Django Auto-Deploy

on:
  push:
    branches: [ master ] # This triggers the script on every push to main branch

jobs:
  deploy:
    runs-on: self-hosted # This tells GitHub to use your Win 11 server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploying updates to the server
        shell: powershell
        run: # 1. Copy fresh files from Runner's directory to Project directory
          # English comment: Syncing files from runner workspace to project folder
          xcopy /E /Y /I "$GITHUB_WORKSPACE\*" "C:\Users\Gleb\SBProduction\SBProduction\"

          # 2. Now enter the project folder to run migrations
          cd "C:\Users\Gleb\SBProduction\SBProduction"
          
          # 3. Update environment and DB
          & ".\venv\Scripts\python.exe" -m pip install -r requirements.txt
          & ".\venv\Scripts\python.exe" manage.py migrate --noinput
          
          # 4. Restart service
          Restart-Service -Name "DjangoAPI" -Force
